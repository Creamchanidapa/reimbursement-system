<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <title>Request - Reimbursement System</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-image: url('S__3956756.jpg'); background-size: cover; background-position: center; background-attachment: fixed; }
        .glass-container { background: rgba(255, 255, 255, 0.96); border-radius: 3rem; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-animate { animation: modalShow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes modalShow { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen">
    <nav class="bg-blue-900/90 backdrop-blur-md text-white p-5 sticky top-0 z-40 shadow-2xl">
        <div class="container mx-auto flex justify-between items-center px-4">
            <h1 class="font-bold text-lg">REIMBURSEMENT</h1>
            <button onclick="location.href='index.html'" class="bg-red-500 hover:bg-red-600 px-5 py-2 rounded-xl text-sm font-bold shadow-lg transition-all">ออกจากระบบ</button>
        </div>
    </nav>

    <div class="container mx-auto py-12 px-4 max-w-6xl">
        <div class="glass-container p-10 shadow-xl border">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold text-slate-800" id="welcomeUser">ใบเบิกเงิน</h2>
                <button onclick="addItem()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-bold shadow-xl transition-all">+ เพิ่มใบเสร็จ</button>
            </div>

            <div id="aiAlert" class="hidden mb-6 p-5 bg-green-50 border-2 border-green-200 text-green-700 rounded-[1.5rem] flex items-center gap-3 fade-in">
                <span class="text-2xl"></span>
                <span class="font-bold">ตรวจสอบข้อมูลครบถ้วนแล้ว! คุณสามารถกดส่งได้เลยค่ะ</span>
            </div>

            <div id="itemsList" class="space-y-8"></div>

            <button id="submitBtn" disabled onclick="finalSubmit()" class="w-full mt-8 bg-slate-200 text-slate-400 py-6 rounded-[2.5rem] font-bold text-2xl transition-all shadow-inner">
                ส่งรายการเบิกทั้งหมด
            </button>
        </div>
    </div>

    <div id="successModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-lg z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-[3.5rem] p-12 max-w-md w-full shadow-2xl text-center modal-animate">
            <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner text-4xl">✓</div>
            <h3 class="text-3xl font-bold text-slate-800 mb-4 tracking-tighter">ส่งเอกสารสำเร็จ!</h3>
            <p class="text-slate-500 mb-8 font-bold">บันทึกลง Google Sheets และส่งเมลแจ้งพนักงานแล้ว</p>
            <button onclick="location.href='index.html'" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition-all shadow-xl">กลับหน้าหลัก</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbznfEEGDaUJQt4-w2ImCtI61Xt53NxVfugkmk82QNxzx5OHqdC21ZnJF_QWQESDm1Xg/exec";
        let receiptItems = [];
        const userData = JSON.parse(localStorage.getItem('userData') || '{"name":"-","email":"-"}');
        document.getElementById('welcomeUser').innerText = `รายการเบิกเงินของคุณ ${userData.name}`;

        function addItem() {
            const id = Date.now();
            const html = `
                <div id="card-${id}" class="bg-white/50 p-8 rounded-[2.5rem] border-2 border-white relative shadow-sm fade-in">
                    <button onclick="removeItem(${id})" class="absolute top-6 right-8 text-red-500 font-bold bg-red-50 px-3 py-1 rounded-full text-xs hover:bg-red-100">ลบรายการ</button>
                    <div id="ai-loading-${id}" class="hidden absolute inset-0 bg-white/80 rounded-[2.5rem] flex items-center justify-center z-10 font-bold text-blue-600">
                        <div class="loader mr-3"></div> AI กำลังอ่านใบเสร็จ...
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 ml-2 uppercase">Email ผู้เบิก</label>
                            <input type="email" value="${userData.email}" readonly class="w-full p-4 rounded-2xl border-none bg-slate-100 text-slate-400 outline-none cursor-not-allowed">
                        </div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 ml-2 uppercase">ชื่อพนักงาน</label>
                            <input type="text" value="${userData.name}" readonly class="w-full p-4 rounded-2xl border-none bg-slate-100 text-slate-400 outline-none cursor-not-allowed">
                        </div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 ml-2 uppercase font-bold text-blue-600">โรงพยาบาล</label>
                            <input type="text" id="hosp-${id}" oninput="update(${id})" class="w-full p-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 ml-2 uppercase font-bold text-blue-600">เลขที่ใบเสร็จ (Auto)</label>
                            <input type="text" id="inv-${id}" oninput="update(${id})" class="w-full p-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 ml-2 uppercase font-bold text-blue-600">ยอดเงินเบิก (Auto)</label>
                            <input type="number" id="amt-${id}" oninput="update(${id})" class="w-full p-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-blue-400 outline-none" step="0.01">
                        </div>
                        <div class="space-y-1"><label class="text-xs font-bold text-slate-500 ml-2 uppercase font-bold text-blue-600">วันที่เบิก (Auto)</label>
                            <input type="date" id="date-${id}" oninput="update(${id})" class="w-full p-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-blue-400 outline-none">
                        </div>
                        <div class="col-span-full">
                            <label class="text-xs font-bold text-blue-600 ml-2 uppercase underline">แนบรูปใบเสร็จเพื่อกรอกข้อมูลอัตโนมัติ</label>
                            <input type="file" onchange="handleFile(this, ${id})" accept="image/*" class="w-full p-3 text-xs text-slate-400 bg-white/80 rounded-2xl shadow-sm border border-slate-100 mt-1">
                        </div>
                    </div>
                </div>`;
            document.getElementById('itemsList').insertAdjacentHTML('beforeend', html);
            receiptItems.push({ id, email: userData.email, name: userData.name, hosp: '', amt: 0, inv: '', date: '', file: 'uploaded' });
            validate();
        }

        async function handleFile(input, id) {
            if (input.files && input.files[0]) {
                const loader = document.getElementById(`ai-loading-${id}`);
                loader.classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageData = e.target.result;
                    // บันทึกสถานะว่ามีการเลือกไฟล์แล้ว
                    receiptItems.find(it => it.id === id).file = imageData;
                    try {
                        const result = await Tesseract.recognize(imageData, 'tha+eng');
                        const text = result.data.text;
                        
                        // OCR Logic สำหรับใบเสร็จรามาธิบดี
                        const invM = text.match(/(?:No\.|เลขที่)\s*(\d{9})/i) || text.match(/\b\d{9}\b/);
                        if (invM) document.getElementById(`inv-${id}`).value = invM[1] || invM[0];
                        
                        const amtM = text.match(/(\d{1,3}(?:,\d{3})*\.\d{2})/g);
                        if (amtM) document.getElementById(`amt-${id}`).value = amtM[amtM.length - 1].replace(/,/g, '');
                        
                        const dateM = text.match(/(\d{2}\/\d{2}\/\d{4})/);
                        if (dateM) { 
                            const d = dateM[1].split('/'); 
                            document.getElementById(`date-${id}`).value = `${d[2]}-${d[1]}-${d[0]}`; 
                        }
                        
                        if (text.includes("รามาธิบดี")) document.getElementById(`hosp-${id}`).value = "คณะแพทยศาสตร์โรงพยาบาลรามาธิบดี";
                    } catch (err) { console.error(err); }
                    loader.classList.add('hidden');
                    update(id);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function update(id) {
            const item = receiptItems.find(it => it.id === id);
            item.hosp = document.getElementById(`hosp-${id}`).value;
            item.amt = parseFloat(document.getElementById(`amt-${id}`).value) || 0;
            item.inv = document.getElementById(`inv-${id}`).value;
            item.date = document.getElementById(`date-${id}`).value;
            validate();
        }

        function validate() {
            const isOk = receiptItems.length > 0 && receiptItems.every(it => it.hosp && it.inv && it.amt > 0 && it.date && it.file);
            const btn = document.getElementById('submitBtn');
            const alert = document.getElementById('aiAlert');
            if(isOk) {
                btn.disabled = false; 
                btn.className = "w-full mt-8 bg-blue-700 text-white py-6 rounded-[2.5rem] font-bold text-2xl shadow-2xl scale-100 hover:scale-[1.01] transition-all cursor-pointer";
                alert.classList.remove('hidden');
            } else {
                btn.disabled = true; 
                btn.className = "w-full mt-8 bg-slate-200 text-slate-400 py-6 rounded-[2.5rem] font-bold text-2xl cursor-default transition-all";
                alert.classList.add('hidden');
            }
        }

        async function finalSubmit() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = `<div class="loader mr-3"></div> กำลังบันทึกข้อมูล...`;

            // เตรียมรายการส่งข้อมูล
            const uploadPromises = receiptItems.map(item => 
                fetch(SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors", 
                    body: JSON.stringify({ 
                        action: "insert", 
                        to_email: item.email, 
                        to_name: item.name, 
                        hosp: item.hosp, 
                        inv: item.inv, 
                        amt: item.amt, 
                        date: item.date 
                    })
                })
            );

            try {
                // ส่งทุกใบพร้อมกันแบบขนาน (Parallel) เพื่อความเร็วสูงสุด
                await Promise.all(uploadPromises);
                
                // บันทึกสำรองไว้ใน LocalStorage
                const existing = JSON.parse(localStorage.getItem('masterRecords') || '[]');
                receiptItems.forEach(i => existing.push({ ...i, status: 'Pending' }));
                localStorage.setItem('masterRecords', JSON.stringify(existing));

                // แสดง Pop-up สำเร็จทันที
                document.getElementById('successModal').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                alert("การส่งข้อมูลบางรายการผิดพลาด แต่ระบบได้บันทึกสำรองไว้ในเครื่องแล้ว");
                btn.disabled = false;
                btn.innerText = "ส่งรายการเบิกทั้งหมด";
            }
        }

        function removeItem(id) { 
            document.getElementById(`card-${id}`).remove(); 
            receiptItems = receiptItems.filter(it => it.id !== id); 
            validate(); 
        }

        // เริ่มต้นเพิ่ม 1 ใบเสร็จ
        addItem();
    </script>
</body>
</html>