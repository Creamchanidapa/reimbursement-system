<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <title>Admin - Reimbursement System</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-image: url('S__3956756.jpg'); background-size: cover; background-position: center; background-attachment: fixed; }
        .glass-table { background: rgba(255, 255, 255, 0.95); border-radius: 2.5rem; overflow: hidden; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-animate { animation: modalShow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes modalShow { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .glass-modal { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body class="min-h-screen pb-20">
    <nav class="bg-slate-900/90 backdrop-blur-md text-white p-5 shadow-xl flex justify-between">
        <h1 class="font-bold text-blue-400 text-lg flex items-center gap-2">ADMIN CONTROL</h1>
        <a href="index.html" class="bg-red-500 hover:bg-red-600 px-5 py-2 rounded-xl text-xs font-bold shadow-lg">LOGOUT</a>
    </nav>

    <div class="container mx-auto py-10 px-4">
        <div class="glass-table shadow-2xl border border-white/20">
            <div class="p-8 bg-slate-50/50 border-b font-bold text-slate-800 flex justify-between items-center text-sm">
                <span>ตรวจสอบรายการ</span>
                <span id="pendingCount" class="bg-blue-600 text-white px-4 py-1 rounded-full text-xs shadow-md">0 รายการ</span>
            </div>
            <table class="w-full text-left text-xs">
                <thead class="bg-slate-50/50 text-slate-400 uppercase font-bold tracking-wider">
                    <tr>
                        <th class="p-6">แถวที่</th>
                        <th class="p-6">พนักงาน</th>
                        <th class="p-6">เลขใบเสร็จ</th>
                        <th class="p-6 text-right">ยอดเงิน</th>
                        <th class="p-6 text-center">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="adminBody" class="divide-y divide-slate-100 font-bold">
                    <tr><td colspan="5" class="p-10 text-center text-slate-400">กำลังดึงข้อมูลล่าสุด...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="actionModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-modal rounded-[3rem] p-10 max-w-md w-full shadow-2xl text-center modal-animate">
            <div id="iconBox" class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-inner transition-all duration-500"></div>
            <h3 id="modalTitle" class="text-2xl font-bold text-slate-800 mb-2"></h3>
            <div class="mt-4 mb-6 text-left">
                <label class="block text-xs font-bold text-slate-400 mb-2 ml-4 font-bold">เหตุผลที่ส่งให้พนักงาน:</label>
                <textarea id="adminReason" class="w-full p-4 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 text-sm" rows="3"></textarea>
            </div>
            <div id="loadingStatus" class="hidden mb-6 py-4 bg-blue-50/50 rounded-2xl text-blue-700 font-bold text-xs flex items-center justify-center gap-3 border border-blue-100">
                <div class="loader"></div> กำลังสื่อสารกับ Google Sheets...
            </div>
            <div class="flex gap-4" id="modalButtons">
                <button onclick="closeModal()" class="flex-1 bg-slate-200 text-slate-600 py-4 rounded-2xl font-bold hover:bg-slate-300 transition-all">ยกเลิก</button>
                <button id="confirmActionBtn" class="flex-1 text-white py-4 rounded-2xl font-bold shadow-lg transition-all"></button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbznfEEGDaUJQt4-w2ImCtI61Xt53NxVfugkmk82QNxzx5OHqdC21ZnJF_QWQESDm1Xg/exec";
        let currentRecord = null;

        async function load() {
            const body = document.getElementById('adminBody');
            try {
                // ดึงข้อมูลจริงจาก Google Sheets ผ่านฟังก์ชัน doGet
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                const pendingRecords = data.filter(it => it.status === 'Pending');
                document.getElementById('pendingCount').innerText = `${pendingRecords.length} รายการ`;
                
                body.innerHTML = '';
                if(pendingRecords.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 font-bold">ไม่พบรายการค้างตรวจสอบ</td></tr>';
                    return;
                }

                pendingRecords.forEach((item) => {
                    body.innerHTML += `
                        <tr class="hover:bg-blue-50/50 transition-colors">
                            <td class="p-6 font-mono text-slate-400 text-[10px]">แถว ${item.rowIndex}</td>
                            <td class="p-6 text-slate-800">${item.name}<br><span class="text-[10px] text-blue-500 underline">${item.email}</span></td>
                            <td class="p-6 text-slate-500 leading-relaxed">${item.hosp}<br>INV: ${item.inv}</td>
                            <td class="p-6 text-right text-slate-900 font-mono">฿${item.amt.toLocaleString()}</td>
                            <td class="p-6 text-center space-x-2 whitespace-nowrap">
                                <button onclick='openActionModal(${JSON.stringify(item)}, "approve")' class="bg-green-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-md hover:bg-green-700 transition-all active:scale-95">อนุมัติ</button>
                                <button onclick='openActionModal(${JSON.stringify(item)}, "reject")' class="bg-red-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-md hover:bg-red-600 transition-all active:scale-95">Reject</button>
                            </td>
                        </tr>`;
                });
            } catch (err) {
                body.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-red-500 font-bold">ไม่สามารถดึงข้อมูลได้ (โปรดตรวจสอบการ Deploy Web App)</td></tr>';
            }
        }

        function openActionModal(item, type) {
            currentRecord = item;
            document.getElementById('adminReason').value = ""; 
            const modal = document.getElementById('actionModal');
            const icon = document.getElementById('iconBox');
            const confirmBtn = document.getElementById('confirmActionBtn');
            modal.classList.remove('hidden');

            if(type === 'approve') {
                document.getElementById('modalTitle').innerText = "ยืนยันการอนุมัติ";
                document.getElementById('modalTitle').className = "text-2xl font-bold text-green-700 mb-2";
                icon.className = "w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm";
                icon.innerHTML = '✓';
                confirmBtn.innerText = "ยืนยันและส่งเมล"; 
                confirmBtn.className = "flex-1 bg-green-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-700";
                confirmBtn.onclick = () => processRealTime('อนุมัติ');
            } else {
                document.getElementById('modalTitle').innerText = "ยืนยันการปฏิเสธ";
                document.getElementById('modalTitle').className = "text-2xl font-bold text-red-700 mb-2";
                icon.className = "w-20 h-20 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl shadow-sm";
                icon.innerHTML = '✕';
                confirmBtn.innerText = "ยืนยัน Reject"; 
                confirmBtn.className = "flex-1 bg-red-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-red-600";
                confirmBtn.onclick = () => processRealTime('ปฏิเสธ');
            }
        }

        async function processRealTime(statusLabel) {
            const reason = document.getElementById('adminReason').value;
            if(!reason) return alert("กรุณาระบุเหตุผลก่อนกดยืนยันครับ");
            
            document.getElementById('loadingStatus').classList.remove('hidden');
            document.getElementById('modalButtons').classList.add('hidden');
            
            try {
                // ส่ง rowIndex ที่ดึงมาจาก Sheet ไปเพื่อให้แก้ถูกแถวแน่นอน
                await fetch(SCRIPT_URL, { 
                    method: "POST", 
                    mode: "no-cors", 
                    body: JSON.stringify({ 
                        action: "updateStatus",
                        rowIndex: currentRecord.rowIndex, 
                        inv: currentRecord.inv,
                        status: statusLabel,
                        reason: reason,
                        to_email: currentRecord.email,
                        to_name: currentRecord.name
                    }) 
                });

                document.getElementById('loadingStatus').innerHTML = "อัปเดตแถว " + currentRecord.rowIndex + " สำเร็จ!";
                setTimeout(() => location.reload(), 1000);
            } catch (err) { 
                alert("เกิดข้อผิดพลาดในการเชื่อมต่อ"); 
                closeModal(); 
            }
        }

        function closeModal() { 
            document.getElementById('actionModal').classList.add('hidden'); 
            document.getElementById('loadingStatus').classList.add('hidden'); 
            document.getElementById('modalButtons').classList.remove('hidden'); 
        }

        load();
    </script>
</body>
</html>